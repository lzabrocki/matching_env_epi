---
title: "Propensity Score Matching"
description: |
  Detailled Script.
author:
  - name: Tarik Benmarhnia 
    url: https://profiles.ucsd.edu/tarik.benmarhnia
    affiliation: University of California San Diego
    affiliation_url: https://profiles.ucsd.edu/tarik.benmarhnia
  - name: Marie-Abèle Bind 
    url: https://scholar.google.com/citations?user=gyPCRcEAAAAJ&hl=fr
    affiliation: 	Massachusetts General Hospital
    affiliation_url: https://scholar.google.com/citations?user=gyPCRcEAAAAJ&hl=fr
  - name: Léo Zabrocki 
    url: https://www.parisschoolofeconomics.eu/en/
    affiliation: Paris School of Economics
    affiliation_url: https://www.parisschoolofeconomics.eu/en/
date: "`r Sys.Date()`"
output: 
    distill::distill_article:
      toc: true
      toc_depth: 3
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

<style>
body {
text-align: justify}
</style>

In this document, we provide all steps and R codes required to estimate the effect of heat waves of the number of years of life lost (YoLL) using propensity score matching. The implementation is done with the fantastic package [MatchIt](https://kosukeimai.github.io/MatchIt/index.html): do not hesitate to explore its very well-made documentation. We also rely on the [cobalt]()**Should you have any questions, need help to reproduce the analysis or find coding errors, please do not hesitate to contact us at leo.zabrocki@psemail.eu**

# Required Packages and Data Loading

To reproduce exactly the `4_propensity_score_matching.html` document, we first need to have installed:

* the [R](https://www.r-project.org/) programming language 
* [RStudio](https://rstudio.com/), an integrated development environment for R, which will allow you to knit the `4_propensity_score_matching.Rmd` file and interact with the R code chunks
* the [R Markdown](https://rmarkdown.rstudio.com/) package
* and the [Distill](https://rstudio.github.io/distill/) package which provides the template for this document. 

Once everything is set up, we load the following packages:

```{r, echo = TRUE}
# load required packages
library(knitr) # for creating the R Markdown document
library(here) # for files paths organization
library(tidyverse) # for data manipulation and visualization
library(broom) # for cleaning regression outputs
library(MatchIt) # for matching procedures
library(cobalt) # for assessing covariates balance
library(Cairo) # for printing custom police of graphs
library(DT) # for displaying the data as tables
```

We load our custom `ggplot2` theme for graphs:

```{r, echo = TRUE}
# load ggplot custom theme
source(here::here(
  "2.scripts",
  "functions",
  "script_theme_tufte.R"
))
# define nice colors
my_blue <- "#0081a7"
my_orange <- "#fb8500"
```

We finally load the data:

```{r, echo = TRUE}
# load the data
data <-
  readRDS(here::here("1.data", "simulated_environmental_data.rds"))
```

As a reminder, there are `r nrow(data %>% filter(heat_wave==1))` days where an heat wave occurred and `r nrow(data %>% filter(heat_wave==0))` days without heat waves.

# Propensity Score Matching

We first implement below a propensity score matching procedure where:

*  each day with an heat wave is matched to the most similar day without heat wave (1:1 nearest neighbor matching without replacement)
* the distance metric used for the matching is the propensity score which is predicted using a logistic model where we regress the heat wave dummy on its three lags, the three lags of ozone, nitrogen dioxide and its three lags, the relative humidity, the calendar indicators for the day of the week, the week and the year.

We vary the matching distance to see how covariates balance change:

1. We first match each treated unit to its closest control unit.
2. We then set the maximum distance (i.e., the caliper) allowed between a treated and control unit to be inferior 1 propensity score standard deviation. 
3. We finally set the maximum distance (i.e., the caliper) allowed between a treated and control unit to be inferior 0.5 propensity score standard deviation. 

Once treated and control units are matched, we then assess whether covariates has improved. 

We finally estimate the treatment effect.

### Matching Procedure

We first match each treated unit to its closest control unit without any caliper using the `matchit()` function:

```{r, echo = TRUE}
# match without caliper
matching_ps_no_calliper <-
  matchit(
    heat_wave ~ heat_wave_lag_1 + heat_wave_lag_2 + heat_wave_lag_3 + o3_lag_1 + o3_lag_2 + o3_lag_3 + no2 + no2_lag_1 + no2_lag_2 + no2_lag_3 + humidity_relative + month + week + year,
    data = data
  )

# display summary of the procedure
matching_ps_no_calliper
```

The output of the matching procedure indicates us the method (1:1 nearest neighbor matching without replacement) and the distance (propensity score) we used. It also tells us how many units were matched: `length(matching_ps_no_calliper[["match.matrix"]])`. We can then evaluate the covariates balance using the `summary()` function:

```{r, echo = TRUE}
# get summary statistics on covariates balance
balance_ps_no_calliper <- summary(matching_ps_no_calliper) 
```

We display below summary statistics on the covariates balance for the matched data:

```{r, echo = TRUE}
love.plot(matching_ps_no_calliper, binary = "std", thresholds = c(m = .1)) +
  theme_tufte()
shapes = c("circle", "triangle"),
          colors = c("red", "blue"))
```
